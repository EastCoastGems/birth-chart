<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Discover Your Astrology Blueprint</title>
  <style>
    /* ...your CSS styles from your original file... */
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="https://i.ibb.co/ZRrgQ9db/IMG-2055.png" alt="Astrology Blueprint Logo" />
    </header>
    <h1>Discover Your Astrology Blueprint</h1>
    <form id="birth-form" autocomplete="off">
      <label>Date of Birth:
        <input type="date" id="birthdate" required />
      </label>
      <label>Time of Birth:
        <input type="time" id="birthtime" required />
      </label>
      <label>Birthplace (City, State or Country):
        <input type="text" id="location" placeholder="e.g. New York, NY or London, UK" required />
      </label>
      <div class="radio-group">
        <input type="radio" name="readingType" value="bigThree" checked />
        <input type="radio" name="readingType" value="fullChart" />
      </div>
      <button type="submit">Generate Your Chart</button>
    </form>
    <div id="chart-description">
      Your personalized astrology wheel with planetary positions and house cusps.
    </div>
    <div class="chart-container">
      <canvas id="birth-chart" width="400" height="400" aria-label="Astrology chart wheel"></canvas>
    </div>
    <div class="sky-container">
      <canvas id="skyCanvas" width="400" height="250" aria-label="Sky map showing planetary positions"></canvas>
      <button id="downloadBtn">üì• Download Your Sky Map</button>
    </div>
    <div id="results"></div>
  </div>
  <script>
    window.addEventListener('error', function(event) {
      event.preventDefault();
      var resultsDiv = document.getElementById('results');
      if (resultsDiv) {
        resultsDiv.innerHTML = '<div class="error">‚ö†Ô∏è A critical error occurred: ' + event.message + '</div>';
        resultsDiv.style.display = 'block';
      } else {
        alert('A critical error occurred: ' + event.message);
      }
      return false;
    });
    document.addEventListener('DOMContentLoaded', function() {
      // Crystal data
      const crystals = [
        { name: "Rose Quartz", category: "Love & Relationships", properties: "Unconditional love, emotional healing", bestFor: "opening your heart to deeper connections" },
        { name: "Green Aventurine", category: "Love & Relationships", properties: "Heart chakra healing, compassion", bestFor: "healing past relationship wounds" },
        { name: "Moonstone", category: "Love & Relationships", properties: "Divine feminine energy, intuition", bestFor: "balancing emotions in relationships" },
        { name: "Amethyst", category: "Clarity & Intuition", properties: "Third eye activation, spiritual awareness", bestFor: "deepening your spiritual practice" },
        { name: "Clear Quartz", category: "Clarity & Intuition", properties: "Amplification, clarity", bestFor: "clearing mental fog and confusion" },
        { name: "Fluorite", category: "Clarity & Intuition", properties: "Mental clarity, focus", bestFor: "making important decisions" },
        { name: "Citrine", category: "Abundance & Success", properties: "Manifestation, prosperity", bestFor: "attracting financial abundance" },
        { name: "Pyrite", category: "Abundance & Success", properties: "Confidence, willpower", bestFor: "pursuing your goals with determination" },
        { name: "Green Jade", category: "Abundance & Success", properties: "Good fortune, harmony", bestFor: "creating lasting prosperity" },
        { name: "Black Tourmaline", category: "Protection & Grounding", properties: "Psychic protection, grounding", bestFor: "shielding yourself from negative energy" },
        { name: "Hematite", category: "Protection & Grounding", properties: "Grounding, strength", bestFor: "staying centered during challenging times" },
        { name: "Smoky Quartz", category: "Protection & Grounding", properties: "Transmutation, cleansing", bestFor: "releasing what no longer serves you" },
        { name: "Labradorite", category: "Transformation & Growth", properties: "Transformation, magic", bestFor: "embracing major life changes" },
        { name: "Garnet", category: "Transformation & Growth", properties: "Passion, regeneration", bestFor: "igniting your inner fire" },
        { name: "Carnelian", category: "Transformation & Growth", properties: "Courage, creativity", bestFor: "taking bold action toward your dreams" }
      ];

      // Utility functions
      function analyzeBirthChartThemes(results) {
        const themes = [];
        const fireCount = (results.sun.element === 'Fire' ? 1 : 0) + (results.moon.element === 'Fire' ? 1 : 0) + (results.rising.element === 'Fire' ? 1 : 0);
        if (fireCount >= 2) themes.push('Transformation & Growth');
        const earthCount = (results.sun.element === 'Earth' ? 1 : 0) + (results.moon.element === 'Earth' ? 1 : 0) + (results.rising.element === 'Earth' ? 1 : 0);
        if (earthCount >= 2) themes.push('Abundance & Success', 'Protection & Grounding');
        const airCount = (results.sun.element === 'Air' ? 1 : 0) + (results.moon.element === 'Air' ? 1 : 0) + (results.rising.element === 'Air' ? 1 : 0);
        if (airCount >= 2) themes.push('Clarity & Intuition');
        const waterCount = (results.sun.element === 'Water' ? 1 : 0) + (results.moon.element === 'Water' ? 1 : 0) + (results.rising.element === 'Water' ? 1 : 0);
        if (waterCount >= 2) themes.push('Love & Relationships', 'Clarity & Intuition');
        if (themes.length === 0) {
          themes.push('Clarity & Intuition');
        }
        return themes;
      }

      function generateCrystalRecommendations(results) {
        const themes = analyzeBirthChartThemes(results);
        const recommendations = [];
        themes.forEach(theme => {
          const themeArr = crystals.filter(crystal => crystal.category === theme);
          if (themeArr.length > 0) {
            const randomCrystal = themeArr[Math.floor(Math.random() * themeArr.length)];
            if (!recommendations.some(r => r.name === randomCrystal.name)) {
              recommendations.push(randomCrystal);
            }
          }
        });
        while (recommendations.length < 2) {
          const randomCrystal = crystals[Math.floor(Math.random() * crystals.length)];
          if (!recommendations.some(r => r.name === randomCrystal.name)) {
            recommendations.push(randomCrystal);
          }
        }
        return recommendations.slice(0, 3);
      }

      function displayCrystalRecommendations(results) {
        const recommendations = generateCrystalRecommendations(results);
        const crystalHTML = `
          <div class="shopping-section">
            <h3>‚ú® Recommended Crystals for Your Chart ‚ú®</h3>
            <p>Based on your astrological energies, these crystals can support your spiritual journey:</p>
            <div class="crystal-recommendations">
              ${recommendations.map(crystal => `
                <div class="crystal-card">
                  <div class="crystal-name">${crystal.name}</div>
                  <div class="crystal-properties">${crystal.properties}</div>
                  <div class="crystal-best-for">Perfect for ${crystal.bestFor}</div>
                </div>
              `).join('')}
            </div>
            <div style="text-align: center; margin-top: 2rem;">
              <p style="color: #e0e0e0; margin-bottom: 1rem;">Find these beautiful crystals and more in my shop!</p>
              <a href="https://eastcoastgemsbycara.myshopify.com" target="_blank" class="shop-cta">Visit My Crystal Shop</a>
            </div>
          </div>
        `;
        return crystalHTML;
      }

      function getElementForSign(sign) {
        const fireSigns = ['Aries', 'Leo', 'Sagittarius'];
        const earthSigns = ['Taurus', 'Virgo', 'Capricorn'];
        const airSigns = ['Gemini', 'Libra', 'Aquarius'];
        const waterSigns = ['Cancer', 'Scorpio', 'Pisces'];
        if (fireSigns.includes(sign)) return 'Fire';
        if (earthSigns.includes(sign)) return 'Earth';
        if (airSigns.includes(sign)) return 'Air';
        if (waterSigns.includes(sign)) return 'Water';
        return 'Air';
      }

      function renderChart(chartData) {
        const ctx = document.getElementById('birth-chart').getContext('2d');
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.save();
        ctx.translate(ctx.canvas.width / 2, ctx.canvas.height / 2);
        ctx.scale(1, 1);
        ctx.rotate(-Math.PI / 2);
        ctx.translate(-ctx.canvas.width / 2, -ctx.canvas.height / 2);
        const radius = Math.min(ctx.canvas.width, ctx.canvas.height) / 2;
        ctx.beginPath();
        ctx.arc(ctx.canvas.width / 2, ctx.canvas.height / 2, radius, 0, Math.PI * 2);
        ctx.clip();
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.restore();
        const chart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: chartData.labels,
            datasets: [{
              label: 'Planetary Positions',
              data: chartData.data,
              backgroundColor: chartData.backgroundColor,
              borderColor: chartData.borderColor,
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'top',
                labels: {
                  color: '#fff',
                  font: {
                    size: 14
                  }
                }
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: '#777',
                borderWidth: 1
              }
            }
          }
        });
      }

      function renderSkyMap(planetPositions) {
        const canvas = document.getElementById('skyCanvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        ctx.clearRect(0, 0, width, height);
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, width, height);
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.arc(width / 2, height / 2, 90, 0, Math.PI * 2);
        ctx.stroke();
        ctx.fillStyle = '#ff0';
        planetPositions.forEach(planet => {
          const angle = planet.position * (Math.PI / 180);
          const x = width / 2 + Math.cos(angle) * 90;
          const y = height / 2 + Math.sin(angle) * 90;
          ctx.beginPath();
          ctx.arc(x, y, 5, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = '#fff';
          ctx.font = 'bold 12px Arial';
          ctx.fillText(planet.planet, x + 8, y + 4);
        });
      }

      // Chart rendering and API logic
      const CONFIG = {
        apiKey: 'f4828f886eb04102855182883c0428a2',
        backendUrl: 'https://birth-chart-wc1f.onrender.com/api/chart',
        wheelImageUrl: 'https://upload.wikimedia.org/wikipedia/commons/4/4f/Astrological_Chart_-_New_Millennium.svg'
      };
      const elements = {
        form: document.getElementById('birth-form'),
        resultsDiv: document.getElementById('results'),
        chartContainer: document.querySelector('.chart-container'),
        canvas: document.getElementById('birth-chart'),
        skyContainer: document.querySelector('.sky-container'),
        skyCanvas: document.getElementById('skyCanvas'),
        downloadBtn: document.getElementById('downloadBtn'),
        chartDesc: document.getElementById('chart-description'),
        birthdate: document.getElementById('birthdate'),
        birthtime: document.getElementById('birthtime'),
        location: document.getElementById('location')
      };
      const skyCtx = elements.skyCanvas.getContext('2d');
      const SIGNS = ["Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"];
      const PLANET_COLORS = {
        Sun: "#FFD700", Moon: "#C0C0C0", Mercury: "#FFA500", Venus: "#FF69B4",
        Mars: "#FF4500", Jupiter: "#8A2BE2", Saturn: "#2F4F4F",
        Uranus: "#4FD0E3", Neptune: "#4169E1", Pluto: "#8B4513"
      };
      const PLANET_SYMBOLS = {
        Sun: "‚òâ", Moon: "‚òΩ", Mercury: "‚òø", Venus: "‚ôÄ", Mars: "‚ôÇ",
        Jupiter: "‚ôÉ", Saturn: "‚ôÑ", Uranus: "‚ôÖ", Neptune: "‚ôÜ", Pluto: "‚ôá"
      };
      const PLANET_NAMES = {
        0: 'Sun', 1: 'Moon', 2: 'Mercury', 3: 'Venus', 4: 'Mars',
        5: 'Jupiter', 6: 'Saturn', 7: 'Uranus', 8: 'Neptune', 9: 'Pluto'
      };

      elements.form.addEventListener('submit', function(event) {
        event.preventDefault();
        const birthdate = elements.birthdate.value;
        const birthtime = elements.birthtime.value;
        const location = elements.location.value;
        const readingType = document.querySelector('input[name="readingType"]:checked').value;
        elements.resultsDiv.innerHTML = '<div class="loader"></div>';
        elements.resultsDiv.style.display = 'block';
        const birthData = {
          birthdate,
          birthtime,
          location,
          readingType
        };
        fetch(CONFIG.backendUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + CONFIG.apiKey
          },
          body: JSON.stringify(birthData)
        })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            throw new Error(data.error.message);
          }
          const chartData = {
            labels: ['Sun', 'Moon', 'Rising'],
            data: [data.sun.position, data.moon.position, data.rising.position],
            backgroundColor: ['#ffcc00', '#3399ff', '#ff6699'],
            borderColor: ['#e6b800', '#007acc', '#e6007e']
          };
          renderChart(chartData);
          renderSkyMap(data.planetPositions);
          const crystalHTML = displayCrystalRecommendations(data);
          elements.resultsDiv.innerHTML = `
            <div class="results-section">
              <h2>Your Astrology Results</h2>
              <div class="chart-container">
                <canvas id="birth-chart" width="400" height="400" aria-label="Astrology chart wheel"></canvas>
              </div>
              <div class="sky-container">
                <canvas id="skyCanvas" width="400" height="250" aria-label="Sky map showing planetary positions"></canvas>
                <button id="downloadBtn">üì• Download Your Sky Map</button>
              </div>
              ${crystalHTML}
            </div>
          `;
        })
        .catch(error => {
          elements.resultsDiv.innerHTML = '<div class="error">‚ö†Ô∏è ' + error.message + '</div>';
        });
   
